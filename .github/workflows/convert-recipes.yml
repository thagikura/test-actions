name: Convert recipes flow

on:
  push:
  workflow_dispatch:

jobs:
  build-gradle-project:
    runs-on: ubuntu-latest
    steps:
    - name: Checkout project sources
      uses: actions/checkout@v3
    - name: Setup Gradle
      uses: gradle/gradle-build-action@v2
    - name: Initialize mandatory git config
      run: |
       git config user.name "GitHub Actions"
       git config user.email noreply@github.com
    - name: Checkout and run build with Gradle Wrapper
      run: | 
         ARRAY=("8.1.0:8.0.0"
           "8.0.0:8.0.0") 
         for index in "${ARRAY[@]}" ; do
           AGP=${index%%:*}
           GRADLE=${index#*:}
           git checkout -b test-agp-"$AGP"
           cd convert-tool
           ./gradlew standaloneJar
           echo "Built converter"
           cd ..
           java -jar convert-tool/app/build/libs/recipes-converter-all.jar \
            --action convert --sourceAll recipes \
            --destination Recipes \
            --agpVersion "$AGP" --gradleVersion "$GRADLE" --overwrite
           echo "Created recipes"
           mv Recipes/* .
           git add .
           rm -rf ./convert-tool/*
           rm ./convert-tool/.gitattributes
           rm ./convert-tool/.gitignore
           rm -rf ./gradle-resources/*
           rm -rf ./.github/*
           rm -rf ./recipes/*
           git rm -r --cached ./convert-tool/*
           git rm -r --cached ./gradle-resources/*
           git rm -r --cached ./.github/*
           git rm -r --cached ./recipes/*
           echo "Ready for commit"
           git commit --message "Prepare release"
           git push -f --set-upstream origin test-agp-"$AGP"
           git checkout main
           echo "Done"
         done
